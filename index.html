<html>
<head>
<title>KnoxelJS</title>

<link rel="stylesheet" type="text/css" href="./css/style.css">

</head>
<body>

<ul class="tab">
    <li><a href="#javascript" class="tablinks active" id="javascriptTab" onclick="openTab('javascript')">Javascript</a></li>
    <li><a href="#python" class="tablinks" id="pythonTab" onclick="openTab('python')">Python</a></li>
    <li><a href="#game" class="tablinks" id="gameTab" onclick="openTab('game')">Game</a></li>
    <li><a href="#about" class="tablinks" id="aboutTab" onclick="openTab('about')">About</a></li>
</ul>

<div id="game" class="tabcontent">
    <input type="file" id="loadDrawing" class="inputfile">
    <label for="loadDrawing">Load Drawing from JSON</label>
    
    <div id="loadDrawingErrors" class="error"></div>
    
    <div id="gamediv" class="game">
    </div>
</div>

<div id="javascript" class="tabcontent editor" style="display:block;">
    <button id="runJavascript" onclick="runJavascript()">Run Javascript code!</button>
    
    <div id="javascriptErrors" class="error"></div>
    
    <div id="javascriptEditor" class="editor">
const width = 2;
const depth = 3;
const height = 4;
let blocks = knoxel.makeGrid(width, depth, height);

for (let w=0; w&lt;width; w++){
    for (let d=0; d&lt;depth; d++){
        for (let h=0; h&lt;height; h++){
            blocks[w][d][h] = knoxel.dirt;
        }
    }
}
knoxel.drawBlocks(blocks);
    </div>

</div>

<div id="python" class="tabcontent editor">
    <button id="runPython" onclick="runPython()">Run Python code!</button>

    <div id="pythonErrors" class="error"></div>

    <div id="pythonEditor" class="editor">
width = 2
depth = 3
height = 4
#blocks = [[[null for k in xrange(height)] for j in xrange(depth)] for i in xrange(width)]
blocks = makeGrid(width, depth, height)

for i in xrange(width):
    for j in xrange(depth):
        for k in xrange(height):
            blocks[i][j][k] = bt.cobblestone

drawBlocks(blocks)
    </div>
</div>

<div id="about" class="tabcontent">
    <div>
        Knoxel aspires to bring the joy of Minecraft to CS-0 and CS-1 courses.
    </div>
    <div>
        <p>Many students have made contributions to Knoxcraft over the years! They are: </p>
        <table id="aboutTable">
        <tr><td>
                <img id="avatarHeadshot" src="./images/kakoijohnAvatar.png"> John Damits, Knox College '17, funded by the Mellon Foundation and the <a href="https://www.knox.edu/academics/research-and-creative-work/student-research-grants/richter-awards">Richter Memorial Trust</a>
        </td></tr>
        <tr><td>
            <img id="avatarHeadshot" src="./images/moemattAvatar.png"> Matt Moe, Knox College '17, funded by the <a href="https://www.knox.edu/academics/research-and-creative-work/student-research-grants/richter-awards">Richter Memorial Trust</a>
        </td></tr>
        <tr><td>
            <img id="avatarHeadshot" src="./images/steveAvatar.png"> Lucas Kasser, Brown University '19
        </td></tr>
        <tr><td>
            <img id="avatarHeadshot" src="./images/EmhastingsAvatar.png"> Emily Hastings, Knox College '16, funded by the <a href="https://www.knox.edu/Documents/PDFs/CRAS/ASSET%20Program%20Description.pdf"> ASSET </a> program, and the <a href="https://www.knox.edu/academics/research-and-creative-work/student-research-grants/richter-awards">Richter Memorial Trust</a>
        
        </td></tr>
        <tr><td>
            <img id="avatarHeadshot" src="./images/steveAvatar.png"> Michael Gerten, Knox College '16, funded by Knox's Baker-Velde award, and the <a href="https://www.knox.edu/academics/research-and-creative-work/student-research-grants/richter-awards">Richter Memorial Trust</a>
        </td></tr>
        <tr><td>
            <img id="avatarHeadshot" src="./images/SpacdogAvatar.png"> Jaime Spacco, Haverford College '98
        </td></tr>
        </table>
    </div>
    <div>
        <p>Knoxcraft is made possible by the following projects:</p>
        <ul>
            <li><a href="http://voxeljs.com/">VoxelJS</a>, blocks in yo browser (required <a href="http://get.webgl.org/">WebGL</a>)</li>
            <li><a href="http://bdcraft.net/sphax-purebdcraft-texturepack">Sphax texture pack</a></li>
            <li><a href="https://skulpt.org/"> Skulpt</a></li>
            <li><a href="https://icons8.com/license">Icons8 (for the numbered icons)</a></li>
            <!--
            
            <li><a href="http://files.minecraftforge.net/">Minecraft Forge</a>, the community-supported moddable Minecraft server</li>
            <li><a href="https://www.spongepowered.org/">Spongepowered</a>, a Minecraft modding API built on Forge</li>
            <li><a href="https://www.javapoly.com/">JavaPoly</a>, Java(script) in your browser</li>
            <li><a href="https://ace.c9.io">ACE editor</a>, part of <a href="https://c9.io/">Cloud9</a></li>
            <li><a href="https://developers.google.com/blockly/">Blockly</a>, a block-based visual programming language</li>
            <li><a href="http://www.eclipse.org/jetty/">Jetty</a>, a webserver and servlet container</li>
            -->
        </ul>
    </div>
    <div>
        <p>Knoxel was inspired by, or is similar to, the following projects:</p>
        <ul>
            <li><a href="https://minecraft.net/">Minecraft</a></li>
            <li><a href="http://scriptcraftjs.org/">ScriptCraftJS</a>, which uses (now defunct) <a href="https://canarymod.net/">Canarymod</a></li>
            <li><a href="http://computercraftedu.com/">ComputerCraftEDU</a></li>
            <li><a href="https://en.wikipedia.org/wiki/Logo_(programming_language)">Seymour Papert's Logo</a></li>
            <li><a href="http://coweb.cc.gatech.edu/mediaComp-teach">Media Computation</a></li>
        </ul>
    </div>
</div>


<script>
//
// show/clear errors from attempting to compile
//
function setError(key, msg) {
    document.getElementById(key).innerHTML = `<p>${msg}</p>`;
}
function clearError(key) {
    document.getElementById(key).innerHTML = '';
}

function openTab(tabName) {
    let tabcontent = document.getElementsByClassName("tabcontent");
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    let tablinks = document.getElementsByClassName("tablinks");
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName+'Tab').className += " active";
}

function runJavascript() {
    // clear the error div
    clearError('javascriptErrors');
    // get student code
    let studentCode = javascriptEditor.getValue();
    try {
        // security risk, but it's all client-side code with no state, so we don't really care
        eval(studentCode);
        openTab('game');
    } catch (error) {
        setError('javascriptErrors', error.toString());
        // TODO: set the markers in ACE
        // 
        // Unfortunately, the format for an error message coming from eval
        // is not standarized across browsers. Errors are likely to generate
        // either ReferenceError (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ReferenceError)
        // or SyntaxError (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SyntaxError)
        // but the only given is the message. The fields for lineNumber, fileName, and stack
        // vary between Chrome and Firefox, and I haven't been able to test IE.
        // 
        // I looked into parsing the text of the full error message to get out
        // the line number, but there are not always line numbers available,
        // plus it's hard for me to text IE since I don't have easy access
        // to a Windows machine, so I just gave up on this part.
        //
        console.log(error);
        // console.log(error.lineNumber);
        // console.log(error.fileName);
        // console.log(error.message);
        // console.log(error.stack);
    }
}

function runPython() {
    // remove markers in ACE
    for (let mark of pythonErrorMarkers) {
        //console.log(`clear error marker ${mark}`);
        pythonEditor.getSession().removeMarker(mark);
    }
    pythonErrorMarkers = [];
    // TODO: Currently it will highlight syntax errors at a lineÂ number,
    // but if you fix the error, the line stays highlighted in ACE until
    // you click on a different line in ACE. I am not sure how to fix this.
    // Google suggests that resize() will do it, but it doesn't work.
    pythonEditor.resize();

    // clear error div
    clearError('pythonErrors');

    // get student code from editor, then paste our base code in front of it
    let studentCode = pythonEditor.getValue();
    // prepend with the pykcbase code, which contains all the block types
    let fullCode = pykcLibraryCode + studentCode;

    // configure and run the python code
    Sk.configure({});
    var myPromise = Sk.misceval.asyncToPromise(function() {
        return Sk.importMainWithBody("<stdin>", false, fullCode, true);
    });
    myPromise.then(function(mod) {
        // on success, switch to the game tab
        openTab('game');
    },
    function(err) {
        // rewrite error messages to subtract off the length of our base code
        let errmsg = err.toString();
        
        // set error div
        setError('pythonErrors', errmsg);
        
        // ugly post-processing of errors
        // TODO: do Skulpt ever give multiple line numbers in a single error?
        let regex = /line ([0-9]+)/g;
        let newmsg = errmsg;
        match = regex.exec(newmsg);
        while (match != null) {
          // matched text: match[0]
          // match start: match.index
          // capturing group n: match[n]
          let oldline = match[0];
          let num = match[1];
          // subtract off the length of the pykcbase code
          // to convert to the line number in the editor window
          let newNum = num - pykcCodeLen + 1;
          
          // mark line in ace editor
          let errid = pythonEditor.session.addMarker(new Range(newNum-1, 0, newNum-1, 1), "aceErrorMarker", "fullLine");
          // add identifier for the marked line to our global variable 
          // storing python error markers
          pythonErrorMarkers.push(errid);
          //console.log(`errid ${errid}`);
          let newline = `line ${newNum}`;
          newmsg = newmsg.replace(oldline, newline);
          match = regex.exec(newmsg);
        }
        console.log(newmsg);
    });
    
}
</script>


<!-- load code for the embedded ACE editor -->
<script src="./ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="./ace-builds/src-min-noconflict/theme-twilight.js" type="text/javascript" charset="utf-8"></script>
<script src="./knoxel-bundle.js"></script>
<script src="./pykc/skulpt.min.js"></script>
<script src="./pykc/skulpt-stdlib.js"></script>

<script>
    // load the pykc base code
    var pykcLibraryCode = null;
    var pykcCodeLen = -1;
    let client = new XMLHttpRequest();
    // 3rd paramter false makes this a synchronous request
    // async requests don't always finish before we need this information
    client.open('GET', './pykc/pykcbase.py', false);
    client.onreadystatechange = function() {
      pykcLibraryCode = client.responseText+"\n\n";
      pykcCodeLen = pykcLibraryCode.split(/\r\n|\r|\n/).length;
    }
    client.send();
    
    // shimming Skulpt: Adding a new "builtin" function that hooks directly
    // into the drawBlocks() function available in knoxel.js
    Sk.builtins.drawBlocks = function(blocks) {
        // convert from Skupt to pure JS, then pass off to JS function in our bundle
        let jsblocks = [];
        
        // all JS values in Skulpt are objects where 
        // the actual JS values are stored with key v
        //console.log(`blocks.v.length ${blocks.v.length}`);
        for (let w=0; w<blocks.v.length; w++){
            let row = [];
            //console.log(`blocks.v[w].v.length ${blocks.v[w].v.length}`);
            for (let d=0; d<blocks.v[w].v.length; d++){
                let col = [];
                //console.log(`blocks.v[w].v[d].v.length ${blocks.v[w].v[d].v.length}`);
                for (let h=0; h<blocks.v[w].v[d].v.length; h++){
                    col.push(blocks.v[w].v[d].v[h].v);
                }
                row.push(col);
            }
            jsblocks.push(row);
        }
        // Call into our bundled JS code
        knoxel.drawBlocks(jsblocks);
    }

    // Ace range function
    var Range = ace.require('ace/range').Range;

    // setup the javascript ACE editor
    var javascriptEditor = ace.edit("javascriptEditor");
    javascriptEditor.setTheme("ace/theme/twilight");
    javascriptEditor.getSession().setMode("ace/mode/javascript");
    javascriptEditor.setAutoScrollEditorIntoView(true);
    javascriptEditor.setFontSize(20);
    var javascriptErrorMarkers = [];

    // setup the python ACE editor
    var pythonEditor = ace.edit("pythonEditor");
    pythonEditor.setTheme("ace/theme/twilight");
    pythonEditor.getSession().setMode("ace/mode/python");
    pythonEditor.setAutoScrollEditorIntoView(true);
    pythonEditor.setFontSize(20);
    var pythonErrorMarkers = [];

    // attach the game object to the game div
    knoxel.game.appendTo(document.getElementById("gamediv"));

    // wrapper function
    function loadDrawingWrapper(event) {
        clearError('loadDrawingErrors');
        // using then/catch because knoxel returns a promise
        knoxel.loadDrawing(event).then( () => {
            // do nothing
        }).catch( (error) => {
            //console.log(`FUNGUS FUCK ${error}\n`);
            setError('loadDrawingErrors', error);  
        });
    }

    // set the event handler for upload drawing files
    document.getElementById("loadDrawing").onchange = loadDrawingWrapper;

</script>

</body>
</html>